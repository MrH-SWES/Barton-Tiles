<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Barton Reading Tile Board</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap"
    rel="stylesheet"
  />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Lexend', sans-serif; overflow: hidden; touch-action: none; }
    #app { display: flex; flex-direction: column; height: 100vh; background-color: #f3f4f6; }
    #wordPane { flex: 1; background-color: white; border-bottom: 4px solid #1f2937; padding: 20px; overflow: auto; position: relative; }
    #wordPane .hint { color: #9ca3af; text-align: center; margin-top: 80px; font-size: 18px; }
    #tileTray { background-color: #e5e7eb; border-top: 2px solid #9ca3af; overflow-y: auto; max-height: 45vh; }
    .tile { width: 60px; height: 60px; border: 2px solid #374151; border-radius: 4px; cursor: grab; display: flex; align-items: center; justify-content: center; font-weight: bold; user-select: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); touch-action: none; flex-shrink: 0; }
    .tile:active { cursor: grabbing; }
    .tile.blue { background-color: #60a5fa; }
    .tile.yellow { background-color: #fbbf24; }
    .tile.red { background-color: #f87171; }
    .tile.green { background-color: #4ade80; }
    .tile.orange { background-color: #fb923c; }
    .tile.purple { background-color: #a78bfa; }
    .tile.dragging { opacity: 0.9; position: fixed; z-index: 1000; pointer-events: none; }
    .alphabet-section { border-bottom: 2px solid #9ca3af; padding: 12px; }
    .lesson-selector-bar { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 8px; background-color: #d1d5db; border-radius: 4px; margin-bottom: 12px; }
    .lesson-selector-bar label { font-weight: bold; }
    .lesson-selector-bar select { font-family: 'Lexend', sans-serif; font-size: 16px; padding: 4px; }
    .tile-row { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
    .drawer { border-bottom: 1px solid #9ca3af; }
    .drawer-header { width: 100%; background-color: #d1d5db; padding: 8px 16px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border: none; text-align: left; }
    .drawer-header:hover { background-color: #9ca3af; }
    .drawer-content { background-color: #f3f4f6; padding: 8px; display: none; }
    .drawer-content.open { display: flex; flex-wrap: wrap; gap: 4px; }
    .word-pane-tile { position: absolute; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="app">
    <div id="wordPane">
      <div class="hint">Drag tiles here to build words. Tap to hear the sound.</div>
    </div>

    <div id="tileTray">
      <div class="alphabet-section">
        <div class="lesson-selector-bar">
          <label for="lessonSelect">Select Level:</label>
          <select id="lessonSelect">
            <option value="2">Book 2: Consonants & Short Vowels</option>
            <option value="3">Book 3: Closed & Unit Syllables</option>
            <option value="4">Book 4: Vowel Teams</option>
            <option value="5">Book 5: Prefixes & Suffixes</option>
            <option value="6">Book 6: Silent-E</option>
            <option value="7">Book 7: Vowel-R</option>
            <option value="8">Book 8: Advanced Vowel Teams</option>
            <option value="9">Book 9: Foreign Influences</option>
            <option value="10">Book 10: Greek & Latin</option>
          </select>
        </div>
        <div class="tile-row" id="lessonTiles"></div>
      </div>

      <div class="drawer" id="drawer-units">
        <button class="drawer-header" data-drawer="wordUnits">
          <span>Glued Sounds & Units (Red)</span><span class="arrow">▼</span>
        </button>
        <div class="drawer-content" id="wordUnits"></div>
      </div>

      <div class="drawer" id="drawer-suffixes">
        <button class="drawer-header" data-drawer="affixes">
          <span>Suffixes (Green)</span><span class="arrow">▼</span>
        </button>
        <div class="drawer-content" id="affixes"></div>
      </div>

      <div class="drawer" id="drawer-prefixes">
        <button class="drawer-header" data-drawer="prefixes">
          <span>Prefixes & VCE Units (Orange)</span><span class="arrow">▼</span>
        </button>
        <div class="drawer-content" id="prefixes"></div>
      </div>

      <div class="drawer" id="drawer-roots">
        <button class="drawer-header" data-drawer="latin">
          <span>Latin & Greek Roots (Purple)</span><span class="arrow">▼</span>
        </button>
        <div class="drawer-content" id="latin"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const TILE_SIZE = 60;
    const SNAP_DISTANCE = 10;

    // Tap vs drag thresholds
    const DRAG_START_PX = 8;      // move > 8px => drag
    const TAP_MAX_TIME_MS = 250;  // up to 250ms => tap
    const TAP_MAX_MOVE_PX = 6;    // <6px movement => tap

    // Minimal grapheme=>"sound" strings to drive speechSynthesis.
    const PHONEME_MAP = {
      a: "ă", e: "ĕ", i: "ĭ", o: "ŏ", u: "ŭ",
      ch: "ch", sh: "sh", th: "th", wh: "hw", ck: "k",
      ph: "f", tch: "ch", dge: "j",
      ar: "ar", or: "or", er: "ər", ir: "ər", ur: "ər", ear: "eer",
      ai: "ā", ay: "ā", ee: "ē", ea: "ē", oa: "ō", oe: "ō", ue: "o͞o", ew: "o͞o", ow: "ō",
      oi: "oi", oy: "oi", au: "aw", aw: "aw", oo: "o͝o", ou: "ow", igh: "ī",
      ps: "s", rh: "r", mn: "n", wr: "r", kn: "n", gh: "g", gn: "n", que: "k", gu: "gw", gue: "g",
      b: "b", c: "k", d: "d", f: "f", g: "g", h: "h", j: "j", k: "k", l: "l", m: "m", n: "n",
      p: "p", qu: "kw", r: "r", s: "s", t: "t", v: "v", w: "w", x: "ks", y: "y", z: "z",
      y_vowel: "ĭ"
    };

    // Barton-style level sets
    const B_LEVELS = {
      2: { blue: ["b","c","d","f","g","h","j","k","l","m","n","p","qu","r","s","t","v","w","x","y","z","ch","ck","sh","th","wh"], yellow: ["a","e","i","o","u"] },
      3: { red: ["all","ang","ing","ong","ung","ank","ink","onk","unk","oll","old","olt","ost","ild","ind"] },
      4: { yellow: ["ai","ay","ee","oa","oe","ue","ew","ow"] },
      5: { green: ["s","es","ed","ing","er","est","ist","y","en","ish","ity","able","tion","sion"], orange: ["dis","in","un","non","mis","sub","re","pre","inter","mid","over","up"] },
      6: { blue: ["ph"], yellow: ["y"], red: ["ture"], green: ["ible","ble","cle","dle","fle","gle","kle","ple","tle","zle"], orange: ["ate","ite","ine","ice","ace","age"] },
      7: { yellow: ["ar","or","er","ir","ur","ear"], green: ["ary","ery","ory"] },
      8: { yellow: ["ie","oi","oy","ey","au","aw","oo","ou","ow","ea","igh","augh","eigh","ei","eu","tu"] },
      9: { blue: ["ps","rh","mn","wr","kn","gh","gn","que","gu","gue"], yellow: ["eau","our"], orange: ["age"] },
      10:{ purple: ["astro","auto","bio","chron","geo","graph","hydro","phon","tele","demo","fac","form","fort","fract","ject","jud","mal","mater","mit","mort","multi","pater","port","rupt","scrib","script","sect","sec","sent","spect","struct"] }
    };

    // ====== STATE ======
    let blueTiles = [], yellowTiles = [], redTiles = [], greenTiles = [], orangeTiles = [], purpleTiles = [];
    let tiles = [];                 // tiles on the pane
    let draggedTile = null;         // ephemeral drag meta
    let draggedGroup = [];          // members moving together
    let dragOffset = { x: 0, y: 0 };
    let gesture = null;             // tap vs drag
    let dragStartRowY = null;       // row y at drag start

    // ====== UTIL ======
    function getFontSize(text) {
      if (text.length <= 2) return '24px';
      if (text.length === 3) return '20px';
      if (text.length === 4) return '16px';
      if (text.length === 5) return '14px';
      return '12px';
    }

    function getUniqueSorted(arr) {
      return [...new Set(arr)].sort((a, b) => (a.length === b.length ? a.localeCompare(b) : a.length - b.length));
    }

    function sameRowY(y1, y2) { return Math.abs(y1 - y2) < TILE_SIZE / 2; }
    function areFlush(a, b, tol = 2) { return Math.abs(a.x + TILE_SIZE - b.x) <= tol; }

    // Recompute groupIds for the row around a given y
    function recomputeGroupsAround(rowY) {
      const row = tiles.filter(t => sameRowY(t.y, rowY)).sort((a,b) => a.x - b.x);
      let i = 0;
      while (i < row.length) {
        let j = i + 1;
        while (j < row.length && areFlush(row[j-1], row[j])) j++;
        const seg = row.slice(i, j);
        if (seg.length === 1) {
          seg[0].groupId = null;
        } else {
          const gid = seg[0].groupId || seg[0].id;
          for (const t of seg) t.groupId = gid;
        }
        i = j;
      }
    }

    // Get the full chain for a tile (use groupId if present; otherwise reconstruct by flush)
    function getGroupChain(main) {
      if (main.groupId) {
        return tiles
          .f
